<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <title>Test Runner</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
    }

    body {
      font-family: -apple-system, system-ui, sans-serif;
      line-height: 1.5;
      background: #fff;
      color: #000;
      display: flex;
      flex-direction: column;
    }

    .status-bar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: #f8f8f8;
      border-bottom: 1px solid #eee;
      padding: 12px 24px;
      font-size: 13px;
      color: #666;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 10;
    }

    .status-bar.running {
      background: #ff9900;
      border-bottom-color: #ff9900;
      color: #fff;
      font-weight: 500;
    }

    .status-bar.success {
      background: #22863a;
      border-bottom-color: #22863a;
      color: #fff;
    }

    .status-bar.failure {
      background: #cb2431;
      border-bottom-color: #cb2431;
      color: #fff;
    }

    .container {
      flex: 1;
      max-width: 900px;
      margin: 0 auto;
      padding: 60px 24px 24px;
      width: 100%;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }

    h1 {
      font-size: 32px;
      font-weight: 600;
      letter-spacing: -0.5px;
      margin-bottom: 8px;
    }

    .subtitle {
      color: #666;
      margin-bottom: 32px;
    }

    .browser-info {
      padding: 12px 16px;
      background: #f8f8f8;
      border: 1px solid #eee;
      border-radius: 6px;
      margin-bottom: 24px;
      font-size: 13px;
    }

    .browser-info h3 {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 8px;
      color: #666;
    }

    .browser-info code {
      font-family: 'SF Mono', Monaco, monospace;
      font-size: 12px;
    }

    .controls {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 24px;
    }

    button {
      font-family: inherit;
      font-size: 14px;
      padding: 10px 16px;
      border: 1px solid #ddd;
      border-radius: 6px;
      cursor: pointer;
      background: #fff;
      color: #000;
      transition: all 0.15s;
    }

    button:hover {
      border-color: #000;
    }

    button.primary {
      background: #000;
      color: #fff;
      border-color: #000;
    }

    button.primary:hover {
      opacity: 0.8;
    }

    button.danger {
      color: #cb2431;
      border-color: #cb2431;
    }

    button.danger:hover {
      background: #cb2431;
      color: #fff;
    }

    button:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    select {
      font-family: inherit;
      font-size: 14px;
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      background: #fff;
      cursor: pointer;
    }

    select:hover {
      border-color: #000;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 12px;
      margin-bottom: 24px;
      padding: 16px;
      background: #f8f8f8;
      border-radius: 6px;
    }

    .stat-card {
      text-align: center;
    }

    .stat-label {
      font-size: 12px;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }

    .stat-value {
      font-size: 24px;
      font-weight: 600;
      font-family: 'SF Mono', Monaco, monospace;
    }

    .stat-value.passed { color: #22863a; }
    .stat-value.failed { color: #cb2431; }
    .stat-value.skipped { color: #b08800; }

    .progress-bar {
      height: 3px;
      background: #eee;
      border-radius: 2px;
      margin-bottom: 24px;
      overflow: hidden;
    }

    .progress-bar-fill {
      height: 100%;
      background: #000;
      width: 0%;
      transition: width 0.3s ease;
    }

    .output {
      flex: 1;
      min-height: 300px;
      padding: 16px;
      background: #1a1a1a;
      color: #e6e6e6;
      font-family: 'SF Mono', Monaco, monospace;
      font-size: 13px;
      line-height: 1.6;
      border-radius: 6px;
      overflow-y: auto;
    }

    .test-log {
      padding: 2px 0;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .test-log-pass { color: #85e89d; }
    .test-log-fail { color: #f97583; }
    .test-log-skip { color: #ffea7f; }
    .test-log-error {
      color: #f97583;
      margin-left: 24px;
      font-size: 12px;
      opacity: 0.8;
    }
    .test-log-summary {
      color: #79b8ff;
      font-weight: 600;
    }
    .test-log-info { color: #e6e6e6; }

    .loading {
      color: #666;
      padding: 24px;
      text-align: center;
    }

    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid #333;
      border-top-color: #666;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-right: 8px;
      vertical-align: middle;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    footer {
      margin-top: auto;
      padding: 24px 0;
      border-top: 1px solid #eee;
      color: #999;
      font-size: 14px;
      flex-shrink: 0;
    }

    footer a {
      color: #999;
      text-decoration: none;
    }

    footer a:hover {
      color: #000;
      text-decoration: underline;
    }

    kbd {
      font-family: 'SF Mono', Monaco, monospace;
      font-size: 12px;
      padding: 2px 6px;
      background: #f4f4f4;
      border: 1px solid #ddd;
      border-radius: 3px;
    }

    @media (prefers-color-scheme: dark) {
      body { background: #000; color: #fff; }
      .status-bar { background: #111; border-bottom-color: #222; color: #666; }
      .status-bar.running { background: #ff9900; border-bottom-color: #ff9900; color: #000; }
      .status-bar.success { background: #22863a; }
      .status-bar.failure { background: #cb2431; }
      .browser-info { background: #111; border-color: #222; }
      .browser-info h3 { color: #888; }
      button { background: #111; color: #fff; border-color: #333; }
      button:hover { border-color: #666; }
      button.primary { background: #fff; color: #000; border-color: #fff; }
      button.danger { color: #f97583; border-color: #f97583; }
      button.danger:hover { background: #cb2431; color: #fff; }
      select { background: #111; color: #fff; border-color: #333; }
      select:hover { border-color: #666; }
      .stats { background: #111; }
      .stat-label { color: #888; }
      .progress-bar { background: #222; }
      .progress-bar-fill { background: #fff; }
      .output { background: #0d0d0d; }
      footer { border-top-color: #222; }
      footer a:hover { color: #fff; }
      kbd { background: #222; border-color: #333; }
    }
  </style>
</head>
<body>
  <div class="status-bar" id="statusBar">
    <span id="statusText">Ready</span>
    <span id="statusInfo"><kbd>Ctrl</kbd>+<kbd>Enter</kbd> to run</span>
  </div>

  <div class="container">
    <h1>Test Runner</h1>
    <p class="subtitle">MemoryFile test suite</p>

    <div class="browser-info" id="browserInfo">
      <h3>Browser Support</h3>
      <div id="browserSupportDetails">Checking capabilities...</div>
    </div>

    <div class="controls">
      <button id="runAllBtn" class="primary">Run All Tests</button>
      <button id="runUnitBtn">Unit</button>
      <button id="runIntegrationBtn">Integration</button>
      <button id="runPerformanceBtn">Performance</button>
      <button id="clearBtn" class="danger">Clear</button>
      <select id="testFilter">
        <option value="all">All Tests</option>
        <option value="unit">Unit Tests Only</option>
        <option value="integration">Integration Tests Only</option>
        <option value="performance">Performance Tests Only</option>
      </select>
    </div>

    <div class="progress-bar">
      <div class="progress-bar-fill" id="progressBar"></div>
    </div>

    <div class="stats" id="stats">
      <div class="stat-card">
        <div class="stat-label">Total</div>
        <div class="stat-value" id="totalTests">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Passed</div>
        <div class="stat-value passed" id="passedTests">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Failed</div>
        <div class="stat-value failed" id="failedTests">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Skipped</div>
        <div class="stat-value skipped" id="skippedTests">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Duration</div>
        <div class="stat-value" id="duration">0ms</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Success</div>
        <div class="stat-value" id="successRate">0%</div>
      </div>
    </div>

    <div class="output" id="output">
      <div class="loading">Ready to run tests. Click "Run All Tests" to begin.</div>
    </div>

    <footer>
      <a href="../">Home</a> ·
      <a href="/examples/">Examples</a> ·
      <a href="https://github.com/AmbientAccent/memoryfile">GitHub</a>
    </footer>
  </div>

  <!-- Embedded Database Placeholder -->
  <script id="embedded-db" type="application/x-sqlite3"></script>

  <!-- SQLite WASM -->
  <script src="../lib/sql-wasm.js"></script>

  <!-- Core Library -->
  <script src="../lib/html-sqlite-core.js"></script>

  <!-- Test Framework -->
  <script src="../lib/test-utils.js"></script>

  <!-- Test Suites -->
  <script src="../lib/unit-tests.js"></script>
  <script src="../lib/integration-tests.js"></script>
  <script src="../lib/performance-tests.js"></script>
  <script src="../lib/commit-cycle-tests.js"></script>

  <!-- Main Test Runner -->
  <script>
    let testRunner;
    let currentResults = null;

    window.MEMORYFILE_WASM_PATH = '../lib/';

    document.addEventListener('DOMContentLoaded', async () => {
      await checkBrowserSupport();
      testRunner = new TestRunner();

      window.Assert = Assert;
      window.MockDatabase = MockDatabase;
      window.PerformanceTest = PerformanceTest;
      window.TestDataGenerator = TestDataGenerator;

      await registerAllTests();
      setupEventHandlers();
      
      // Auto-run tests if URL parameter is set (?autorun or ?autorun=integration)
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.has('autorun')) {
        const type = urlParams.get('autorun') || 'all';
        console.log(`Auto-running ${type} tests...`);
        setTimeout(() => runTests(type), 500);
      }
    });

    async function checkBrowserSupport() {
      const support = await HTMLSQLiteFusion.getBrowserSupport();
      const el = document.getElementById('browserSupportDetails');
      
      const items = [
        ['WebAssembly', support.webAssembly],
        ['File System Access', support.fileSystemAccess],
        ['OPFS', support.opfs],
        ['IndexedDB', support.indexedDB]
      ];

      el.innerHTML = items.map(([name, ok]) => 
        `<code>${name}: ${ok ? 'yes' : 'no'}</code>`
      ).join(' · ');
    }

    async function registerAllTests() {
      if (typeof registerUnitTests === 'function') {
        await registerUnitTests(testRunner);
      }
      if (typeof registerIntegrationTests === 'function') {
        await registerIntegrationTests(testRunner);
      }
      if (typeof registerPerformanceTests === 'function') {
        await registerPerformanceTests(testRunner);
      }
      if (typeof registerCommitCycleTests === 'function') {
        await registerCommitCycleTests(testRunner);
      }
    }

    function setupEventHandlers() {
      document.getElementById('runAllBtn').addEventListener('click', () => runTests('all'));
      document.getElementById('runUnitBtn').addEventListener('click', () => runTests('unit'));
      document.getElementById('runIntegrationBtn').addEventListener('click', () => runTests('integration'));
      document.getElementById('runPerformanceBtn').addEventListener('click', () => runTests('performance'));
      document.getElementById('clearBtn').addEventListener('click', clearOutput);
    }

    function setStatus(text, state = '') {
      const bar = document.getElementById('statusBar');
      const textEl = document.getElementById('statusText');
      bar.className = 'status-bar' + (state ? ' ' + state : '');
      textEl.textContent = text;
    }

    async function runTests(type = 'all') {
      clearOutput();
      setStatus('Running tests...', 'running');

      const output = document.getElementById('output');
      output.innerHTML = '<div class="loading"><span class="spinner"></span>Running tests...</div>';
      document.getElementById('progressBar').style.width = '0%';

      let testsToRun = testRunner.tests;
      if (type !== 'all') {
        testsToRun = testRunner.tests.filter(t => {
          if (type === 'unit') return t.name.includes('Initialization') || t.name.includes('Database Creation') || t.name.includes('SQL Execution') || t.name.includes('Prepared Statements') || t.name.includes('Database Export') || t.name.includes('Base64 Encoding') || t.name.includes('Database Metadata') || t.name.includes('Transactions') || t.name.includes('Browser Support') || t.name.includes('Error Handling') || t.name.includes('Memory Management') || t.name.includes('Index') || t.name.includes('Foreign Keys');
          if (type === 'integration') return t.name.includes('Complete Workflow') || t.name.includes('Save and Load') || t.name.includes('Multi-Table') || t.name.includes('Migration') || t.name.includes('Real-World') || t.name.includes('Edge Cases');
          if (type === 'performance') return t.name.includes('Performance') || t.name.includes('benchmark') || t.name.includes('Scalability') || t.name.includes('Memory');
          return true;
        });
        testRunner.tests = testsToRun;
      }

      await new Promise(resolve => setTimeout(resolve, 50));

      try {
        currentResults = await testRunner.runAll(output);
        updateStats(currentResults);
        document.getElementById('progressBar').style.width = '100%';
        
        if (currentResults.failed === 0) {
          setStatus(`All ${currentResults.passed} tests passed`, 'success');
        } else {
          setStatus(`${currentResults.failed} of ${currentResults.total} tests failed`, 'failure');
        }
      } catch (error) {
        console.error('Test runner error:', error);
        output.innerHTML += `<div class="test-log test-log-fail">Fatal error: ${error.message}</div>`;
        setStatus('Error running tests', 'failure');
      }
    }

    function updateStats(results) {
      document.getElementById('totalTests').textContent = results.total;
      document.getElementById('passedTests').textContent = results.passed;
      document.getElementById('failedTests').textContent = results.failed;
      document.getElementById('skippedTests').textContent = results.skipped;
      
      const duration = testRunner.endTime - testRunner.startTime;
      document.getElementById('duration').textContent = duration + 'ms';
      
      const successRate = results.total > 0 
        ? ((results.passed / results.total) * 100).toFixed(1)
        : 0;
      document.getElementById('successRate').textContent = successRate + '%';
    }

    function clearOutput() {
      const output = document.getElementById('output');
      output.innerHTML = '<div class="loading">Output cleared. Ready for next test run.</div>';
      
      document.getElementById('totalTests').textContent = '0';
      document.getElementById('passedTests').textContent = '0';
      document.getElementById('failedTests').textContent = '0';
      document.getElementById('skippedTests').textContent = '0';
      document.getElementById('duration').textContent = '0ms';
      document.getElementById('successRate').textContent = '0%';
      document.getElementById('progressBar').style.width = '0%';
      setStatus('Ready');
    }

    document.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        e.preventDefault();
        runTests('all');
      } else if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
        e.preventDefault();
        clearOutput();
      }
    });
  </script>
</body>
</html>
